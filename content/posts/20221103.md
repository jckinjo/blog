---
title: "Telegramã§å¤šè¨€èªãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’ä½œã£ãŸè©±"
date: 2022-11-03T00:00:00+00:00
tags: ["æ—¥æœ¬èª", "python"]
author: "Me"
categories: ["tech"]

editPost:
    URL: "https://github.com/jckinjo/blog/tree/master/content"
    Text: "Suggest Changes" # edit text
    appendFilePath: true # to append file path to Edit link
---

å…ˆæ—¥[å¤šè¨€èªWebãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¢ãƒ—ãƒª](../20220418/)ã‚’ä½œã‚Šã¾ã—ãŸã€‚
é€šå‹¤é›»è»Šã§å½“æ—¥ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ã—ãªãŒã‚‰ã€å¤–å›½èªã‚’å‹‰å¼·ã§ãã‚‹ã®ã§ã€ã¾ã‚ã¾ã‚ä½¿ã„ã‚„ã™ã‹ã£ãŸã§ã™ã€‚

å®Ÿã¯ã“ã®Webã‚’é–‹ç™ºã™ã‚‹1å¹´ã»ã©å‰ã«ã€ä¸€åº¦Telegram botã§å¤šè¨€èªãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’é–‹ç™ºã—ã¦ã„ã¾ã—ãŸã€‚ä»Šæ—¥ã¯ãã‚Œã«ã¤ã„ã¦ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

https://github.com/jckinjo/multitrue-bot

## äº‹å‰æº–å‚™

### Telegram bot

Telegramã¯æ—¥æœ¬ã§ã¯ã‚ã¾ã‚Šäººæ°—ãŒãªã„ã§ã™ãŒã€Telegramã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œã‚‹ã ã‘ã§APIã‚­ãƒ¼ã‚’å–å¾—ã§ãã‚‹ã®ã§ã€ã–ãã£ã¨ãƒœãƒƒãƒˆä½œã‚ŠãŸã„å ´åˆã¯ä½¿ã„å‹æ‰‹ãŒã‘ã£ã“ã†ã„ã„ã§ã™ã€‚ã¾ãŸã€è‰¯ã•ã’ã®SDKã‚‚ã‚ã‚Šã¾ã™â†“ã€‚ãã†ã„ã†æ„å‘³ã§ã¯Slackã‚‚åŒã˜ã§ã™ãŒã€Telegramã¯æ„Ÿè¦šçš„ã«Lineã«è¿‘ã„ã®ã§æ‰‹è»½ã•ã§å‹ã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚

https://github.com/python-telegram-bot/python-telegram-bot/tree/master/examples

### ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®å–å¾—
ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®å–å¾—æ–¹æ³•ã¯å…ˆæ—¥é–‹ç™ºã—ãŸWebã‚¢ãƒ—ãƒªã¨åŒã˜ã[NewsAPI](https://newsapi.org/)åˆ©ç”¨ã—ã¦å–å¾—ã—ã¦ã„ã¾ã™ã€‚ãªãœNewsAPIã‚’æ¡ç”¨ã—ãŸã‹ã«ã¤ã„ã¦ã¯[åŠå¹´å‰ã®è¨˜äº‹](../20220418/)ã§è©³ç´°ã‚’èª¬æ˜ã—ãŸã®ã§ã€å‰²æ„›ã—ã¾ã™ã€‚

## å®Ÿè£…

https://core.telegram.org/
ã«å‚ç…§ã—ã¦ãƒœãƒƒãƒˆã®åˆæœŸè¨­å®šãŒå®Œäº†ã—ãŸã‚‰ã€å®Ÿè£…ã«å…¥ã‚Šã¾ã™ã€‚
ãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã¨ãªã‚Šã¾ã™ã€‚

1. `/start`ã§ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒœãƒƒãƒˆã‚’èµ·å‹•
2. å›½ãƒ»åœ°åŸŸã‚’é¸ã¶
3. ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ã‚¸ãƒ£ãƒ³ãƒ«ã‚’é¸ã¶
4. çµ‚äº†ã‚ã‚‹ã„ã¯2.ã«æˆ»ã‚‹

### å…¨ä½“ãƒ•ãƒ­ãƒ¼

SDKãŒæä¾›ã—ã¦ãã‚ŒãŸä¸‹è¨˜3ã¤ã®handlerã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

- `ConversationHandler`: å…ˆã»ã©è¨­è¨ˆã—ãŸãƒ•ãƒ­ãƒ¼ã«åŸºã¥ã„ã¦handlerã‚’å®šç¾©ã™ã‚‹ã€‚
- `CommandHandler`: ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦ç™ºç«ã•ã‚Œã‚‹ã€‚ä»Šå›ã¯ã€Œå…¥ã‚Šå£ (entry point)ã€ã¨ã—ã¦ä½¿ã†ã€€
- `CallbackQueryHandler`: ä»–ã®handlerã®è¿”ã‚Šå€¤ã«ã‚ˆã£ã¦ç™ºç«ã•ã‚Œã‚‹

```python
def main():
    updater = Updater(
        token=json.load(open(KEY_PATH / "keys.json", "r"))["telegram_key"],
        use_context=True,
    )

    dispatcher = updater.dispatcher
    country_pattern = "^us|jp|cn|tw|kr|gb$"
    headlines_pattern = "^us|jp|cn|tw|kr|gb business|entertainment|general|health|science|sports|technology|$"

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            "CATEGORY": [CallbackQueryHandler(select_category, pattern=country_pattern)],
            "HEADLINES": [CallbackQueryHandler(get_news, pattern=headlines_pattern)],
            "START OVER OR NOT": [
                CallbackQueryHandler(start_over, pattern="^start over$"),
                CallbackQueryHandler(end, pattern="^end$"),
            ],
        },
        fallbacks=[CommandHandler("start", start)],
    )

    dispatcher.add_handler(conv_handler)

    updater.start_polling()
    updater.idle()
```

### ãƒ¡ãƒ‹ãƒ¥ãƒ¼

ç¶šã„ã¦ã¯callbacké–¢æ•°ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚`start`é–¢æ•°ã¯welcomeãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ã«é€ã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ã«å›½ãƒ»åœ°åŸŸã‚’é¸ã‚“ã§ã‚‚ã‚‰ã„ã¾ã™ã€‚ãã®å¾Œã€`select_category`é–¢æ•°ã§ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ã‚¸ãƒ£ãƒ³ãƒ«ã‚’é¸ã‚“ã§ã‚‚ã‚‰ã„ã¾ã™ã€‚

å¼•æ•°`context`ã¨`update`
- `context.user_data`: ãƒœãƒƒãƒˆã‚’åˆ©ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹
- `context.bot`: ãƒœãƒƒãƒˆè‡ªä½“ã‚’æ“ä½œã™ã‚‹ï¼ˆä»Šå›ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã ã‘ï¼‰ã®ã«ä½¿ã†
- `update`: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°ã™ã‚‹ã®ã«ä½¿ã†

```python
def start(update, context):
    user = update.message.from_user
    logger.info("User {} started the conversation.".format(user))
    for i, v in vars(user).items():
        context.user_data[i] = v

    welcome_message = (
        "Hello, {}\n"
        "This is JC News botğŸ—ï¸ğŸ¤–\n\n"
        "You can get Top News Headlines for a Country and a Category from here. \n\n".format(user.first_name)
    )
    print(context)
    keyborad = [
        [
            InlineKeyboardButton("ğŸ‡ºğŸ‡¸", callback_data="us"),
            InlineKeyboardButton("ğŸ‡¯ğŸ‡µ", callback_data="jp"),
            InlineKeyboardButton("ğŸ‡¹ğŸ‡¼", callback_data="tw"),
        ],
        [
            InlineKeyboardButton("ğŸ‡°ğŸ‡·", callback_data="kr"),
            InlineKeyboardButton("ğŸ‡¬ğŸ‡§", callback_data="gb"),
            InlineKeyboardButton("ğŸ‡¨ğŸ‡³", callback_data="cn"),
        ],
    ]

    reply_markup = InlineKeyboardMarkup(keyborad)
    context.bot.send_message(chat_id=update.effective_chat.id, text=welcome_message)
    update.message.reply_text("Please Choose a CountryğŸ¤–", reply_markup=reply_markup)

    return "CATEGORY"
    
def select_category(update, context):
    logger.info("User data from context {}".format(context.user_data))
    logger.info("Chat data from context {}".format(context.chat_data))
    logger.info("Bot data from context {}".format(context.bot_data))

    query = update.callback_query
    query.answer()
    country = query.data
    keyborad = [
        [
            InlineKeyboardButton("ğŸ‘©ğŸ¼â€ğŸ’»Technology", callback_data=country + " technology"),
            InlineKeyboardButton("ğŸ§‘â€ğŸ’¼Business", callback_data=country + " business"),
        ],
        [
            InlineKeyboardButton("ğŸ‘¨ğŸ»â€ğŸ¤Entertainment", callback_data=country + " entertainment"),
            InlineKeyboardButton("ğŸ‘©ğŸ»â€âš•ï¸Health", callback_data=country + " health"),
        ],
        [
            InlineKeyboardButton("ğŸ‘¨ğŸ¿â€ğŸ”¬Science", callback_data=country + " science"),
            InlineKeyboardButton("ğŸ‹ğŸ¼â€â™‚ï¸Sports", callback_data=country + " sports"),
        ],
        [InlineKeyboardButton("ğŸŒGeneral", callback_data=country + " general")],
    ]
    reply_markup = InlineKeyboardMarkup(keyborad)
    query.edit_message_text(text="Please Choose a CategoryğŸ¤–", reply_markup=reply_markup)

    return "HEADLINES"
```

### ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’å–å¾—

æœ€å¾Œã¯æœ€ã‚‚ã‚³ã‚¢ã¨ãªã‚‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’å–å¾—ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã§ã™ã€‚`country`ã¨`category`ã«ã‚ˆã£ã¦NewAPIã‹ã‚‰æœ€æ–°ãƒ›ãƒƒãƒˆãƒ©ã‚¤ãƒ³ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’å–å¾—ã—ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ãŸå¾Œã€ãƒ¦ãƒ¼ã‚¶ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Šã¾ã™ã€‚
å…·ä½“çš„ãªè©³ç´°ã¯èª¬æ˜ã—ã¾ã›ã‚“ãŒã€`NewsAPICollector`ã¨ã„ã†ã‚¯ãƒ©ã‚¹ã§NewAPIã‚’ãƒ©ãƒƒãƒ”ãƒ³ã‚°ã—ã¦ã„ã¾ã™ã€‚

https://github.com/jckinjo/multitrue-bot/blob/main/src/news/collector.py

`country`ã¨`category`ã¯callback_dataã¯ä¸Šè¨˜ã®callbacké–¢æ•°ã‹ã‚‰å–å¾—ã—ã¦ã„ã¾ã™ã€‚Slack Appã®payloadã¨ä¼¼ãŸã‚ˆã†ãªæ„Ÿã˜ã§ã™ã€‚

```python
def get_news(update, context):
    query = update.callback_query
    query.answer()
    country, category = query.data.split(" ")

    nac = NewsAPICollector(country=country, category=category, page_size=10, print_format="telebot")
    nac.collcet_news()
    news_list = nac.news_list

    news_list = news_list[:5] if len(news_list) > 5 else news_list

    context.bot.send_message(
        chat_id=update.effective_chat.id,
        text="Top {} latest news of [{}] [{}] for youğŸ¤–".format(len(news_list), country.upper(), category.upper()),
    )

    for news in news_list:
        context.bot.send_message(chat_id=update.effective_chat.id, text=news)

    keyboard = [
        [
            InlineKeyboardButton("Let's do it again!", callback_data="start over"),
            InlineKeyboardButton("I've had enough...", callback_data="end"),
        ]
    ]

    reply_markup = InlineKeyboardMarkup(keyboard)
    context.bot.send_message(
        chat_id=update.effective_chat.id,
        text="Do you want to start over?ğŸ¤–",
        reply_markup=reply_markup,
    )

    return "START OVER OR NOT"
```


ãƒ‡ãƒ¢ã¯ãƒªãƒã‚¸ãƒˆãƒªã®`README.md`ã®gifã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚

https://github.com/jckinjo/multitrue-bot/


## æœ€å¾Œã«

Telegram botçµŒç”±ã§ãƒ¢ãƒã‚¤ãƒ«é–‹ç™ºçµŒé¨“ãŒã‚¼ãƒ­ã®äººï¼ˆç­†è€…ï¼‰ã‚‚ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’ä½œã‚Šã¾ã—ãŸã€‚ã‚‚ã¡ã‚ã‚“ãƒ‹ãƒ¥ãƒ¼ã‚¹ã ã‘ã§ã¯ãªãã€å®šæœŸçš„ã«æ ªä¾¡ã‚„ä¸å‹•ç”£ä¾¡æ ¼ã‚’å–å¾—ã—ãŸã‚Šã€è‹±å˜èªå¸³ã‚’ä½œã£ã¦å¾©ç¿’ã®ãƒªãƒã‚¤ãƒ³ãƒ‰ã—ãŸã‚Šã™ã‚‹ã‚ˆã†ãªWebã‚¢ãƒ—ãƒªã‚ã‚‹ã„ã¯ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚’é–‹ç™ºã™ã‚‹ã»ã©ã§ã‚‚ãªã„ãƒŸãƒ‹ã‚¢ãƒ—ãƒªã«é©ã—ã¦ã„ã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ
